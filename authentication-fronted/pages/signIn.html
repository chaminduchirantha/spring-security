<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sign In</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/signIn.css">
</head>
<body>

<div class="signin-box">
    <h2>Sign In</h2>
    <div class="mb-3">
        <label for="name" class="form-label">Enter Name</label>
        <input type="text" class="form-control" id="name" placeholder="Enter your name">
    </div>
    <div class="mb-3">
        <label for="password" class="form-label">Enter Password</label>
        <input type="password" class="form-control" id="password" placeholder="Enter your password">
    </div>

    <button type="button" class="btn btn-primary" id="signIn">Sign In</button>

    <div class="signup-link">
        <p>If you don't have an account, <a href="signUp.html">Sign Up</a></p>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $('#signIn').on('click', function () {
        var username = $('#name').val();
        var password = $('#password').val();

        if (username && password) {
            $.ajax({
                method: 'POST',
                url: 'https://spring-security-production-9a8f.up.railway.app/auth/login',
                contentType: 'application/json',
                data: JSON.stringify({
                    username: username,
                    password: password
                }),
                success: function(response) {
                    console.log("Login API Response:", response); // debug

                    const token = response.data?.accessToken;
                    if (token) {
                        // Save to localStorage
                        localStorage.setItem('username', username);
                        localStorage.setItem('token', token);

                        // Get user role
                        $.ajax({
                            method: 'GET',
                            url: 'https://spring-security-production-9a8f.up.railway.app/hello/api/user-info',
                            headers: {
                                'Authorization': 'Bearer ' + token
                            },
                            success: function(userInfo) {
                                const role = userInfo.role;
                                if (role === 'ADMIN') {
                                    console.log("ADMIN Token:", token);
                                    alert('Successfully Login Admin');
                                    window.location.href = 'dashboard.html';
                                } else if (role === 'USER') {
                                    console.log("USER Token:", token);
                                    alert('Successfully Login User');
                                    window.location.href = 'userDashBoard.html';
                                } else {
                                    alert('Unknown user role!');
                                }
                            },
                            error: function () {
                                alert('Session expired or unauthorized');
                            }
                        });
                    } else {
                        alert('Login failed: No token received');
                    }
                },
                error: function (xhr) {
                    let errorMessage = xhr.responseJSON?.message || 'Login failed. Please check your username and password.';
                    alert(errorMessage);
                }
            });
        } else {
            alert('Please enter both username and password');
        }
    });


</script>
</body>
</html>
